<!DOCTYPE html>
<html>
  <head>
    <title>App Inventor - Map Component</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
      /**
       * This map script is an abstraction of a number of functions from the Google maps
       * JavaScript API to be used within a customized WebView as an App Inventor Component.
       *
       * It contains two main objects: thisMap and mapMarkers.
       * thisMap initializes the map and makes use of mapMarkers, which simply encapsulates all
       * functions related to markers placed in the map. It is possible to create other utility
       * objects with other functionality in the SDK such as drawing, layers, or services.
       */

      /**
       * Main function for this script. Initializes the map and all the related functionality.
       *
       */
      var mapContainer = function(centerLat, centerLng, showCenter, initialZoom) {
      
        var map;
        var centerMarker;
        //var markerFunctions;
        var allMarkers = {};
        var zoom = initialZoom || 6;
        var showingCenter = showCenter || true;
        var centerCoords = new google.maps.LatLng(centerLat, centerLng)
        function initialize() {
          var mapOptions = {
            zoom: zoom,
            center: centerCoords,
            disableDoubleClickZoom: true
          };
          map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
          //centerMarker = setCenter(centerCoords);
          //showCenter(showingCenter);

          //Initialize marker functions object, exposes the marker functions.
          //markerFunctions = markerObject(thisMap);
          
        };

        var setCenter = function(location){
          if (centerMarker) 
            centerMarker.setMap(null); // Delete any existing center first.

          centerMarker = createMarker(location, 'Map Center');
          centerMarker.setIcon({path: google.maps.SymbolPath.CIRCLE,
                scale: 6})
          //TODO: include a pan to center?
          panToMarker(centerMarker);
          return centerMarker;
        };

        // Special case of showing a marker only for the center. Might be possible to abstract in
        // markerFunctions, but leaving it here for now (jos).
        var showCenter = function(show){
          if (show) {
            if (centerMarker)
              centerMarker.setMap(map);
          } else {
            centerMarker.setMap(null);
          }

          showingCenter = show;
        };

        var getCenter = function() { 
          return androidObject.sendCenterMarkerToAndroid(centerMarker.createJsonMarker()); 
        };

        var getGoogleMapObject = function() { return map; };

        //not sure why we need this getter; what is the use case for needing these functions?
        //var getMarkerFunctions = function() { return markerFunctions; };

        var getAllMarkers = function() { return allMarkers; };

        var getMarker = function(location) {
          return allMarkers[location.toString()];
        };

        var getMap = function() {
          return map;
        }


        /**
         * Add a marker, with additional information, to the map.
         * @param location {google.maps.LatLng} object specifying the position in the map
         * @param infoWindowContent content to be displayed in this marker infoWindow
         * @param title a title for the marker (shown on hover in browsers)
         */
        var createMarker = function(location, title) {//, infoWindowContent){ 
          var marker;
          var loc;
          var lat;
          var lng;
          var existingMarker;
          if (location instanceof google.maps.LatLng) {
            loc = location;
          } else if (typeof location === "string") {
            loc = locationFromTextCoords(location);
          } else if (location.length == 2) {
            loc = locationFromLatLngCoords(location[0], location[1]);
          } else {
            //try geolocating from address
            //else throw error
            console.log("No valid location.");
            return null;
          }
          lat = loc.lat();
          lng = loc.lng();

          existingMarker = getMarker(loc);
          if (existingMarker) { //If it exists, there's no need to create it
            marker = existingMarker;

            // We override values even if they are not different - it's easier.
            // marker.title = title;
            // if (infoWindowContent && marker.info){
            //   marker.info.setContent(infoWindowContent);
            // }
          } else {
            marker = new markerContainer(map, lat, lng, title, null, null, true, true);
            addMarker(marker);

            // if (infoWindowContent) {
            //   markerFunctions.createInfoWindow(marker.getPosition().toString(), infoWindowContent);
            // }
          }
        // } else if () {

        //   // if {

        //   // } else {
        //   //   console.log('Calling Error handler on Android side');
        //   //   return null;
        //   // }
        // }

          return marker;

        };

        /**
         * Decodes the JSON input and generates and displays markers for each of the objects.
         * Sample data:
         * "[
         *     {"lat":48.856614,"lng":2.3522219000000177,"title":"","content":""},
         *     {"lat":48,"lng":3,"title":"near paris","content":"near Paris content"}
         *  ]"
         * @param listOfMarkers a JSON representation of the markers to be displayed
         */
         //TODO: Do we really want to have a json list? what about a yaillist? or the app inventor list structure?
        var createMarkersFromList = function(listOfMarkers) {
          try {
            var allParsedMarkers = JSON.parse(listOfMarkers);
          } catch(parseError) {
            console.log('List of Markers is not valid JSON. Notifying Android side.');
            return;
          }

          function decodeMarker(markerObject){
            var markerData = [];
            var lat, lng;

            if (markerObject.lat)
              lat = markerObject.lat;

            if (markerObject.lng)
              lng = markerObject.lng;

            if (lat && lng)
              markerData[0] = locationFromLatLngCoords(lat, lng);

            if (markerObject.title)
              markerData[1] = markerObject.title;

            if (markerObject.content)
              markerData[2] = markerObject.content;

            // Location has to be available(other fields are optional).
            if (markerData[0] instanceof google.maps.LatLng)
              return markerData;
            else //TODO (jos) trigger user feedback or not?
              return null;
          }

          allParsedMarkers.forEach(function(markerObject) {
            // Try to decode each marker and even if some fail, still add the others.
            var markerData = decodeMarker(markerObject);
            if (markerData)
              createMarker(markerData[0], markerData[1], markerData[2]);
          });
        };


        //TODO Verify the marker isn't already in the dict? If it is already in the dict it will be overwritten.
        var addMarker = function(marker) {
          var loc = marker.getPosition().toString();
          allMarkers[loc] = marker;
        };

        var addMarkersFromList = function(markerList) {
          //TODO link this in to create marker if not already a marker object?
          for (i = 0; i < markerList.length; i++) {
            if (!getMarker(markerList[i].prototype.getPosition().toString())) {
              addMarker(markerList[i]);
            }
          }
          showMarkers(true);
        };
        
        var locationFromLatLngCoords = function(lat, lng){
          var errorParsing = false;
          if (isNaN(lat) || isNaN(lng)) errorParsing = true;
          //DO WE NEED TO DO THIS? the LatLng will clamp or wrap the coordinates. 
          // if (lat < -90 || lat > 90) errorParsing = true;
          // if (lng < -180 || lng > 180) errorParsing = true;

          if (errorParsing) {
            return null;
          } else {
            return new google.maps.LatLng(lat, lng);
          }
        };

        /**
         * Generates a LatLng map object from coordinates passed in as a string. Valid ranges are:
         * Lat [-90, 90], and Lng [-180, 180].
         * @param locationText a string in the format 'float, float'
         * @returns {google.maps.LatLng} a LatLng object or null if the location is not in the
         * right format.
         */
        var locationFromTextCoords = function(locationText) {
          var lat, lng;
          var locationSplit = locationText.split(',');
          if (locationSplit.length === 2){
            lat = parseFloat(locationSplit[0]);
            lng = parseFloat(locationSplit[1]);
            return locationFromLatLngCoords(lat, lng);
          } else {
            return null;
          }
        };

        var showMarkers = function (show){
          if (show) {
            for (var key in allMarkers){
              getMarker(key).setMap(map);
            }
          } else {
            for (var key in allMarkers){
              getMarker(key).setMap(null);
            }
          }
        };

        //Geolocation service
        var getGeolocationFromAddress = function (address){
          var geocoder = new google.maps.Geocoder();
          geocoder.geocode({address: address}, geolocationResults)
        };

        function geolocationResults(results, status){
          if (status === 'OK') {
            var firstLocationFound = results[0].geometry.location;
            if (firstLocationFound){
              console.log("First loc:", firstLocationFound);
              var marker = createMarker(firstLocationFound);
              var markerJson = createJsonMarkerFromId(marker.prototype.getPosition().toString());
              // return firstLocationFound;
            } else {
              console.log('No location found!');
            }
          } else if (status === "ZERO_RESULTS"){
            console.log('No results found for that particular address.');
          } else {
            console.log('No results found. Status of Geolocation call: ' + status);
          }
        };

        var deleteAllMarkers = function() {
          showMarkers(false);
          allMarkers = {};
        };

        var deleteMarker = function(markerId) {
          if (allMarkers[markerId]) {
            allMarkers[markerId].setMap(null);
            delete allMarkers[markerId];
          }

        };

        var setZoom = function(zoom) {
          if (zoom >= 0 && zoom <= 19){
            map.setZoom(zoom);
          } else { // Exception handling is also done on Android side
            console.log('Zoom value ' + zoom + ' is not in the valid range 0-19');
          }
        };

        var getZoom = function() { return map.zoom; };

        var panToMarker = function(markerId) {
          var markerToPanTo = getMarker(markerId);
          if (markerToPanTo)
            map.panTo(markerToPanTo.getPosition());
        };

        //API for the thisMap object: main entry object for functionality
        return {
          initialize: initialize,
          showCenter: showCenter,
          setCenter: setCenter,
          getCenter: getCenter,
          getGoogleMapObject: getGoogleMapObject, // For Debugging (not used from the component).
          //getMarkerFunctions: getMarkerFunctions,
          getAllMarkers: getAllMarkers,
          getMarker: getMarker,
          createMarker: createMarker,
          createMarkersFromList: createMarkersFromList,
          addMarkersFromList: addMarkersFromList,
          locationFromLatLngCoords: locationFromLatLngCoords,
          locationFromTextCoords: locationFromTextCoords,
          getGeolocationFromAddress: getGeolocationFromAddress,
          showMarkers: showMarkers,
          deleteMarker: deleteMarker,
          deleteAllMarkers: deleteAllMarkers,
          setZoom: setZoom,
          getZoom: getZoom,
          panToMarker: panToMarker,
          getMap: getMap
        }
      //TODO (jos) Magic numbers: the center of the map will come from Android
      } (42.3598, -71.0921, true, 2); //Auto initialize the thisMap object


      /**
       * This function returns an object with certain methods exposed as its API. The functionality
       * of this object is related to management of markers in the map.
       * @returns an Object with methods related to Marker management.
       * @param map the map to associate the markers with. thisMap object from above.
       */
      function markerContainer(map, lat, lng, title, icon, clickable, visible) {

        var marker;
        var id;

        function initialize() {
          var markerOptions = {
              map: map,
              position: {lat: lat, lng: lng},
              title: title,
              icon: icon,
              clickable: clickable,
              visible: visible
            };

          marker = new google.maps.Marker(markerOptions);
          id = marker.getPosition().toString();
          return marker;
        }

      //this exists in the map container
      // markerContainer.deleteMarker = function() {
      //   this.marker.setMap(null);
      //   this.id = null;

      //   delete this.marker; //does this work??
      // };

      //TODO should equality be if their locations/IDs are the same, instead of the same object?
      var equals = function(otherMarker) {
        return marker === otherMarker;
      };

      var getId = function() {
        return id;
      };

      var getIcon = function() {
        return marker.icon;
      };

      var getMap = function() {
        return marker.map;
      };

      var getTitle = function() {
        return marker.title;
      };

      var getClickable = function() {
        return marker.clickable;
      };

      var getPosition = function() {
        return marker.position;
      };

      var getLatitude = function() {
        return marker.position.lat();
      };

      var getLongitude = function() {
        return marker.position.lng();
      }

      var getVisible = function() {
        return marker.visible;
      };

      var getMarkerObject = function() {
        return marker;
      }

      var setIcon = function(icon) {
        marker.setIcon(icon);
      };

      var setMap = function(map) {
        marker.setMap(map);
      };

      var setTitle = function(title) {
        marker.setTitle(title);
      };

      var setClickable = function(clickable) {
        marker.setClickable(clickable);
      }

      var setPosition = function(lat, lng) {
        marker.setPosition({lat: lat, lng: lng});
      };

      var setVisible = function(visible) {
        marker.setVisible(visible);
      };

      var createJsonMarker = function(){
        var markerObject = {
          lat: marker.getPosition().lat(),
          lng: marker.getPosition().lng(),
          title: marker.title || '',
          info: (marker.info && marker.info.content) ?
              marker.info.content : ''
        }
        var markerJson = JSON.stringify(markerObject);

        return markerJson;
      };

      //TODO Does this work? I don't understand the callback...
      // var addListenersForMarkers = function (add) {
      //   if (add){
      //     google.maps.event.addListener(marker.map, 'click', function(event) {
      //       var markerJson = createJsonMarker();
      //     });
      //   } 
      //   else
      //     google.maps.event.clearListeners(map,'click');
      // };

      // InfoWindow functions
      var createInfoWindow = function(content) {
        var infoWindow = new google.maps.InfoWindow({
          content: content
        });
        marker.info = infoWindow;
      };

      var openInfoWindow = function(){
        if (marker && marker.info)
          marker.info.open(marker.map, marker);
      };

      var closeInfoWindow = function(){
        if (marker && marker.info)
          marker.info.close();
      };

      return {
        // deleteMarker: deleteMarker,
        initialize: initialize,
        equals: equals,
        getId: getId,
        getIcon: getIcon,
        getMap: getMap,
        getTitle: getTitle,
        getClickable: getClickable,
        getPosition: getPosition,
        getLatitude: getLatitude,
        getLongitude: getLongitude,
        getVisible: getVisible,
        getMarkerObject: getMarkerObject,
        setIcon: setIcon,
        setMap: setMap,
        setTitle: setTitle,
        setClickable: setClickable,
        setPosition: setPosition,
        setVisible: setVisible,
        createJsonMarker: createJsonMarker,
        createInfoWindow: createInfoWindow,
        openInfoWindow: openInfoWindow,
        closeInfoWindow: closeInfoWindow
      }

      /**
       * An object to hold functions that communicate directly to Android through the JS interface.
       * @type {{ERROR_ILLEGAL_COORDS_FORMAT: number, ERROR_PARSING_MARKERS_LIST: number,
       * ERROR_NO_GEOLOCATION_RESULTS: number, dispatchErrorToAndroid: dispatchErrorToAndroid,
       * sendMarkerToAndroid: sendMarkerToAndroid,
       * sendDoubleMarkerToAndroid: sendDoubleMarkerToAndroid,
       * sendListOfMarkersToAndroid: sendListOfMarkersToAndroid,
       * mapIsReadyToAndroid: mapIsReadyToAndroid,
       * sendUserMarkerAddedToAndroid: sendUserMarkerAddedToAndroid,
       * sendGeolocationMarkerAddedToAndroid: sendGeolocationMarkerAddedToAndroid}}
       */
      var androidObject = {

        // CONSTANTS FOR ERRORS, As defined on the Android side.
        ERROR_ILLEGAL_COORDS_FORMAT: 2802,
        ERROR_PARSING_MARKERS_LIST: 2803,
        ERROR_INVALID_MARKER: 2804,
        ERROR_NO_GEOLOCATION_RESULTS: 2806,

        /**
         * Function to dispatch errors to Android through the AppInventorMap interface. If this
         * file is loaded on a browser, AppInventorMap will be undefined and we skip the
         * dispatching.
         * TODO (jos) think about Error handling in JS if I even want to use this file standalone.
         * @param errorNumber number for the message to display as user feedback on the Android
         * side. The messages are defined in ErrorMessages.java
         */
        dispatchErrorToAndroid: function(errorNumber) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.dispatchError(errorNumber);
        },

        sendCenterMarkerToAndroid: function(jsonMarker) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.handleMarker(jsonMarker);

        },

        /**
         * Function to call to the Android side after a user has clicked on a marker
         */
        sendMarkerToAndroid: function(jsonMarker) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.handleMarker(jsonMarker);
        },

        sendDoubleMarkerToAndroid: function(jsonMarker) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.handleDoubleMarker(jsonMarker);
        },

        /**
         * Function to export all markers to the Android side for storage
         */
        sendListOfMarkersToAndroid: function(markers) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.storeMarkers(markers);
        },

        /**
         * Notify Component that the Map is ready.
         */
        mapIsReadyToAndroid: function() {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.mapIsReady();
        },

        sendUserMarkerAddedToAndroid: function(markerJson) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.userMarkerAdded(markerJson);
        },

        sendGeolocationMarkerAddedToAndroid: function(markerJson, formattedAddress) {
          if (typeof AppInventorMap !== 'undefined')
            AppInventorMap.geolocationMarkerAdded(markerJson, formattedAddress);
        }

      };

      google.maps.event.addDomListener(window, 'load', mapContainer.initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>
